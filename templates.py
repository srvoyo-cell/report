from jinja2 import Template

def build_theory_prompt(theory_text: str) -> str:
    """Создаёт промт для восстановления формул в Markdown для Word."""
    text = r"""
Ты — эксперт по вычислительной математике и оформлению научных текстов.
Твоя задача — восстановить корректные математические формулы и оформить данный текст в **Markdown**, пригодный для конвертации в Word через Pandoc.

Инструкции:
1. Формулы записывай в виде `$ ... $` (встроенные) или `$$ ... $$` (блочные).
2. Формулы должны быть отделены пробелами от текста, чтобы Pandoc корректно их распознал.
3. Используй стандартные обозначения вычислительной математики: интегралы, суммы, индексы, пределы, греческие буквы.
4. Сохрани исходную структуру и смысл текста, не добавляй заголовков, если их не было.
5. Не вставляй LaTeX-команды вроде `\documentclass`, `\begin{document}` и т.п.
6. Не добавляй в начало и конец текста конструкции вроде ```markdown или ``` — вывод должен быть чистым Markdown.

Текст для восстановления:
{{ theory_text }}
"""
    return Template(text).render(theory_text=theory_text)


def build_progress_prompt(theory_fixed: str, code_complete: str) -> str:
    """Создаёт промт для генерации раздела 'Ход работы' в формате Markdown для Word."""
    text = r"""
Ты — автор университетских лабораторных отчётов по программированию и численным методам.
Напиши связный и логичный раздел **«Ход работы»** в формате **Markdown**, пригодный для последующей конвертации в Word.

Требования к структуре и заголовкам:
1. В начале вставь заголовок второго уровня `## Ход работы`.
2. Для каждого крупного этапа используй заголовки третьего уровня `###`.
3. Для подпунктов или шагов внутри этапа — заголовки четвёртого уровня `####`.
4. Соблюдай иерархию — не пропускай уровни.

Стиль:
- Научно-учебный: объясняй смысл шагов программы и их связь с теорией, но **не вставляй формулы из краткой теории**.
- Не пересказывай код — описывай, что реализуется и зачем.
- Используй фразы вроде: “Далее реализуем…”, “Построим график…”, “Полученные результаты подтверждают…”.

Формат:
1. После каждого логического блока вставляй код в виде блока с подписью и нумерацией:
   **Листинг N — Название программы или шага**
   ```(тут нужно указывать язык программы)
   код программы
   ```
2. Если блок формирует график или таблицу, вставляй картинку в виде:
   **Рисунок N — Название графика**
   ![](plot_name.png)
3. Формулы, если они встречаются, записывай через `$...$` или `$$...$$` — Pandoc преобразует их в формат Word.
4. Не добавляй в начало текста строку ```markdown и не ставь закрывающие три бэктика в конце файла.
5. ТУТ ДОЛЖЕН ЗАКОНЧИТЬСЯ MARKDOW. Cимвол ♣ СЛУЖИТ РАЗДЕЛИТЕЛЕМ ДЛЯ ДАЛЬНЕЙШЕГО ПАРСИНГА ДОКУМЕНТА!!!.

ПРИМЕЧАНИЕ: В ready_to_use_code должен формироваться код только с сохранением графиков с тем же названием что и в MARKDOWN без plt.show() и print()
После текста добавь символ ♣ и JSON следующего вида:

{
    "programming_language": "Python (for example)",
    "ready_to_use_code": "all code"
}

Контекст теории:
{{ theory_fixed }}

Код программы:
{{ code_complete }}
"""
    return Template(text).render(
        theory_fixed=theory_fixed,
        code_complete=code_complete
    )