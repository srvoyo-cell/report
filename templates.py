from jinja2 import Template

def build_theory_prompt(theory_text: str) -> str:
    """Создаёт промт для восстановления формул в LaTeX."""
    text = r"""
Ты — эксперт по LaTeX и преподаватель вычислительной математики.
Твоя задача — восстановить корректные математические формулы и оформить данный текст в виде тела LaTeX-документа (без \documentclass и \begin{document}).

Инструкции:
1. Исходный текст может содержать утраченные формулы, обозначенные словами вроде «интеграл», «сумма», «погрешность», «сетка» и т.п.
2. Восстанавливай формулы логически, по контексту, используя стандартные обозначения из курса вычислительной математики.
3. Если встречается нумерация вида (2.1), (2.2) и т.п. — сохрани её через \label.
4. Применяй классический математический стиль: интегралы, суммы, индексы, пределы, греческие буквы.
5. Не добавляй новых смыслов или примеров — только восстанавливай утерянные математические выражения.
6. Форматируй результат строго в LaTeX, без Markdown или пояснений.
7. Исходный текст (его порядок и смысл) менять нельзя — только вставляй корректные формулы.

Текст для восстановления:
{{ theory_text }}
"""
    rendered = Template(text).render(theory_text=theory_text)
    return ' '.join(rendered.split())

def build_progress_prompt(theory_fixed: str, code_complete: str) -> str:
    """Создаёт промт для генерации раздела 'Ход работы'."""
    text = r'''
Ты — автор университетских лабораторных отчётов по программированию и численным методам.
Напиши связный и логичный раздел «Ход работы» в формате LaTeX (только тело документа, без преамбулы и \begin{document}).

Стиль:
- Пиши в научно-учебном стиле: описывай смысл шагов программы и их связь с теорией.
- Избегай пересказа кода — объясняй, что реализуется и зачем.
- Используй фразы вроде: “Далее реализуем…”, “Построим график…”, “Определим функцию…”, “Полученные результаты подтверждают…”.

Формат:
1. Проходи по коду сверху вниз, объединяя логические блоки.
2. После описания каждого блока вставляй код в окружение:
   \begin{lstlisting}
   ...
   \end{lstlisting}
3. Если блок формирует график, таблицу или визуальный результат, сразу после листинга вставь строку:
   \includegraphics[width=1\linewidth]{'picture_name'}
   где 'picture_name' выбирается по контексту (например, 'plot_sin.png').

4. Не изменяй и не комментируй исходный код.
5. Не используй ссылки на формулы (\ref) — перепиши нужные формулы заново в LaTeX-формате.
6. В конце раздела добавь краткий вывод о вычислениях и плавный переход к разделу «Выводы».

Завершение:
После полного текста раздела добавь символ ♣, а затем JSON-объект следующего вида:

{
    "functions": [
        {
            "name": "context_name_1",
            "ready_to_use_code": "import numpy as np\\nimport matplotlib.pyplot as plt\\n ...."
        },

        'and so on...'

        {
            "name": "context_name_n",
            "ready_to_use_code": " "
        }
    ]
}

Функция в ready_to_use_code должна сохранять график с тем же названием что и в \includegraphics[width=1\linewidth]{'picture_name'}.

Контекст теории:
{{ theory_fixed }}

Код программы:
{{ code_complete }}
'''
    rendered = Template(text).render(
        theory_fixed=theory_fixed,
        code_complete=code_complete
    )
    return rendered